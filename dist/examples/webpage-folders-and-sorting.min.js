(()=>{AMF.plugin("Webpage Folders & Sorting",()=>{AMF.on("content-frame-load",({contentWindow:u})=>{let T=new URL(u.location.href);if(T.searchParams.get("act")!=="webpages"||T.searchParams.get("show_all")!=="1")return;let L=u.document.querySelector(".tableborder").querySelector("tbody"),m=Array.from(L.querySelectorAll("tr")),E=m.shift(),N=m.pop(),[y,$,g]=E.querySelectorAll(".titlemedium"),q=u.document.querySelector(".maintitle"),c=!0,s=!0,d=null,p="",f=new Set,S=null,A="webpage-sorting-state",F="webpage-sorting-folders";function C(){sessionStorage.setItem(A,JSON.stringify({filterValue:p,currentSort:d,pageSortAsc:c,modifiedSortAsc:s})),sessionStorage.setItem(F,JSON.stringify(Array.from(f)))}function O(){try{let e=JSON.parse(sessionStorage.getItem(A));if(e)p=e.filterValue||"",d=e.currentSort||null,c=e.pageSortAsc??!0,s=e.modifiedSortAsc??!0;let t=JSON.parse(sessionStorage.getItem(F));if(t)f=new Set(t)}catch{}}function R(e){let t={name:"",path:"",type:"folder",children:[]};return e.forEach((n)=>{let r=n.querySelector("td").textContent.trim().split("/"),l=t,o="";for(let a=0;a<r.length;a++){let w=r[a];o=o?o+"/"+w:w;let x=l.children.find((B)=>B.name===w&&B.type===(a===r.length-1?"file":"folder"));if(!x)x={name:w,path:o,type:a===r.length-1?"file":"folder",children:a===r.length-1?void 0:[],row:a===r.length-1?n:void 0},l.children.push(x);l=x}}),t}function I(e,t){if(!t)return!0;if(e.type==="file"&&e.row)return e.path.toLowerCase().includes(t);return e.children&&e.children.some((n)=>I(n,t))}function b(e){if(!e.children)return;e.children.forEach(b),e.children.sort((t,n)=>{if(t.type==="folder"&&n.type==="file")return-1;if(t.type==="file"&&n.type==="folder")return 1;let i,r;if(d==="page")return i=t.name.toLowerCase(),r=n.name.toLowerCase(),c?i.localeCompare(r):r.localeCompare(i);else if(d==="modified")return i=t.type==="file"&&t.row?new Date(t.row.querySelector("td:nth-child(3)").textContent.trim()):new Date(0),r=n.type==="file"&&n.row?new Date(n.row.querySelector("td:nth-child(3)").textContent.trim()):new Date(0),s?i-r:r-i;else return i=t.name.toLowerCase(),r=n.name.toLowerCase(),i.localeCompare(r)})}function v(e,t,n,i){if(!e.children)return;for(let r of e.children){if(!I(r,i))continue;if(r.type==="folder"){let l=u.document.createElement("tr"),o=u.document.createElement("td");if(o.className="tdrow1",o.colSpan=E.children.length,o.style.paddingLeft=`${n*2}em`,o.style.fontWeight="bold",o.style.cursor="pointer",o.textContent=(f.has(r.path)?"▼ ":"► ")+r.name,l.appendChild(o),l.className="folder-row",l.dataset.path=r.path,l.addEventListener("click",(a)=>{if(a.stopPropagation(),f.has(r.path))f.delete(r.path);else f.add(r.path);C(),h()}),t.appendChild(l),f.has(r.path))v(r,t,n+1,i)}else if(r.type==="file"&&r.row){let l=r.row;l.style.display="";let o=l.querySelector("td");o.style.paddingLeft=`${n*2}em`;let a=o.querySelector("a");if(a)a.textContent=r.name;t.appendChild(l)}}}function h(){let e=p.trim().toLowerCase();L.innerHTML="";let t=u.document.createDocumentFragment();if(t.appendChild(E),!S)S=R(m);b(S),v(S,t,0,e),t.appendChild(N),L.appendChild(t)}let D;function J(e){p=e.target.value,clearTimeout(D),D=setTimeout(()=>{h(),C()},120)}function k(){if(!q)return;let e=u.document.createElement("input");e.type="text",e.placeholder="Filter...",e.style.margin="-4px 4px",e.style.float="right",e.value=p,e.addEventListener("input",J),q.appendChild(e)}function K(){[y,g].forEach((e)=>{e.textContent=e.textContent.replace(/[\u25B2\u25BC]/g,"").trim()})}function H(e,t){K(),e.textContent=e.textContent.trim()+(t?" ▲":" ▼")}function M(){d="page",H(y,c),c=!c,h(),C()}function P(){d="modified",H(g,s),s=!s,h(),C()}function _(){y.style.cursor="pointer",g.style.cursor="pointer",y.addEventListener("click",M),g.addEventListener("click",P)}function V(){m.forEach((e)=>{let t=e.querySelector("td > center");if(t)t.outerHTML=t.innerHTML})}if(V(),O(),k(),_(),d==="page")M(),c=!c;else if(d==="modified")P(),s=!s;h()})});})();
